<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
	<!-- title -->
	
	<title>
	
		springboot应用基于prometheus监控自定义指标&nbsp;&nbsp;✦&nbsp;
	
	Book
	</title>

	<!-- keywords,description -->
	

	

	

	
		<meta name="description" content="每一个不曾起舞的日子，都是对生命的辜负" />
	

	<!-- favicon -->
	


	<!-- search -->
	<script>
		let searchEngine = "https://www.google.com/search?q=";
		if(typeof searchEngine == "undefined" || searchEngine == null || searchEngine == ""){
			searchEngine = "https://www.google.com/search?q=";
		}
		let homeHost = "https://wangchangwei.github.io";
		if(typeof homeHost == "undefined" || homeHost == null || homeHost == ""){
			homeHost = window.location.host;
		}
	</script>


	
<link rel="stylesheet" href="/css/main.css">

	
<link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css">

	
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/styles/darcula.min.css">

	
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">


	
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/highlight.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/npm/jquery-pjax@2.0.1/jquery.pjax.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/npm/darkreader@4.9.58/darkreader.min.js"></script>

	
<script src="/js/main.js"></script>

	
		<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	

	

	
<meta name="generator" content="Hexo 5.4.1"></head>

<body>
	<header id="header">
	<a id="title" href="/" class="log<div class=""></div>
		<img id="logo" src="/favicon-white.ico" alt="logo"/>
		Book
	</a>

	<ul id="menu">
		<li class="menu-item">
			<a href="/about" class="menu-item-link">关于</a>
		</li>
		
		<li class="menu-item">
			<a href="/tags" class="menu-item-link">标签</a>
		</li>
		 
		<li class="menu-item">
			<a href="/categories" class="menu-item-link">分类</a>
		</li>
		
		<li class="menu-item">
			<a href="https://github.com/wangchangwei" class="menu-item-link" target="_blank">
				<i class="fa fa-github fa-2x"></i>
			</a>
		</li>
		<li class="menu-item dark-mode">
			<a href="#" class="menu-item-link">
				<i class="fa fa-moon-o fa-2x"></i>
			</a>
		</li>
	</ul>
</header>

	<div id="sidebar">
	<button id="sidebar-toggle" class="toggle" ><i class="fa fa-arrow-right " aria-hidden="true"></i></button>
	<div id="site-toc">
		<input id="search-input" class="search-input" type="search" placeholder="按回车全站搜索">
		<div id="tree">
			
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2022/11/29/消息队列/消息队列/" title="消息队列/消息队列">
											消息队列
										</a>
									</a>
									
							<ul>
								<li class="file">
									<a href="/2022/06/27/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/kafka/" title="消息队列/kafka">
									
										kafka
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/06/07/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/redis/" title="消息队列/redis">
									
										redis
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/06/07/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/rabbitmq/" title="消息队列/rabbitmq">
									
										rabbitmq
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/06/07/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/rocketmq/" title="消息队列/rocketmq">
									
										rocketmq
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
							</ul>
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2022/06/28/Spring/Spring/" title="Spring/Spring">
											Spring
										</a>
									</a>
									
							<ul>
								<li class="file">
									<a href="/2022/06/28/Spring/%E6%8E%A7%E5%88%B6%E5%8F%8D%E8%BD%AC%EF%BC%88IOC%EF%BC%89%EF%BC%8F%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%EF%BC%88DI%EF%BC%89/" title="Spring/控制反转（IOC）／依赖注入（DI）">
									
										控制反转（IOC）／依赖注入（DI）
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/06/28/Spring/ApplicationContext%20%E5%AE%B9%E5%99%A8/" title="Spring/ApplicationContext 容器">
									
										ApplicationContext 容器
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/06/29/Spring/SSM%20%E6%A1%86%E6%9E%B6%E6%95%B4%E5%90%88/" title="Spring/SSM 框架整合">
									
										SSM 框架整合
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2022/09/29/Spring/Spring Boot/Spring Boot/" title="Spring/Spring Boot/Spring Boot">
											Spring Boot
										</a>
									</a>
									

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2022/09/29/Spring/Spring Boot/应用上下文配置类（ConfigurableApplicationContext）/应用上下文配置类（ConfigurableApplicationContext）/" title="Spring/Spring Boot/应用上下文配置类（ConfigurableApplicationContext）/应用上下文配置类（ConfigurableApplicationContext）">
											应用上下文配置类（ConfigurableApplicationContext）
										</a>
									</a>
									

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2022/09/29/Spring/Spring Boot/应用上下文配置类（ConfigurableApplicationContext）/核心注解（@SpringBootApplication）/核心注解（@SpringBootApplication）/" title="Spring/Spring Boot/应用上下文配置类（ConfigurableApplicationContext）/核心注解（@SpringBootApplication）/核心注解（@SpringBootApplication）">
											核心注解（@SpringBootApplication）
										</a>
									</a>
									

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2022/09/29/Spring/Spring Boot/应用上下文配置类（ConfigurableApplicationContext）/核心注解（@SpringBootApplication）/自动配置类加载（@EnableAutoConfiguration）/自动配置类加载（@EnableAutoConfiguration）/" title="Spring/Spring Boot/应用上下文配置类（ConfigurableApplicationContext）/核心注解（@SpringBootApplication）/自动配置类加载（@EnableAutoConfiguration）/自动配置类加载（@EnableAutoConfiguration）">
											自动配置类加载（@EnableAutoConfiguration）
										</a>
									</a>
									

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2022/09/29/Spring/Spring Boot/应用上下文配置类（ConfigurableApplicationContext）/核心注解（@SpringBootApplication）/自动配置类加载（@EnableAutoConfiguration）/自动导入包（@AutoConfigurationPackage）/自动导入包（@AutoConfigurationPackage）/" title="Spring/Spring Boot/应用上下文配置类（ConfigurableApplicationContext）/核心注解（@SpringBootApplication）/自动配置类加载（@EnableAutoConfiguration）/自动导入包（@AutoConfigurationPackage）/自动导入包（@AutoConfigurationPackage）">
											自动导入包（@AutoConfigurationPackage）
										</a>
									</a>
									
							<ul>
								<li class="file">
									<a href="/2022/09/29/Spring/Spring%20Boot/%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E9%85%8D%E7%BD%AE%E7%B1%BB%EF%BC%88ConfigurableApplicationContext%EF%BC%89/%E6%A0%B8%E5%BF%83%E6%B3%A8%E8%A7%A3%EF%BC%88@SpringBootApplication%EF%BC%89/%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E7%B1%BB%E5%8A%A0%E8%BD%BD%EF%BC%88@EnableAutoConfiguration%EF%BC%89/%E8%87%AA%E5%8A%A8%E5%AF%BC%E5%85%A5%E5%8C%85%EF%BC%88@AutoConfigurationPackage%EF%BC%89/%E7%B1%BB%E5%AF%BC%E5%85%A5%EF%BC%88@Import%EF%BC%89/" title="Spring/Spring Boot/应用上下文配置类（ConfigurableApplicationContext）/核心注解（@SpringBootApplication）/自动配置类加载（@EnableAutoConfiguration）/自动导入包（@AutoConfigurationPackage）/类导入（@Import）">
									
										类导入（@Import）
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/09/29/Spring/Spring%20Boot/%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E9%85%8D%E7%BD%AE%E7%B1%BB%EF%BC%88ConfigurableApplicationContext%EF%BC%89/%E6%A0%B8%E5%BF%83%E6%B3%A8%E8%A7%A3%EF%BC%88@SpringBootApplication%EF%BC%89/%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E7%B1%BB%E5%8A%A0%E8%BD%BD%EF%BC%88@EnableAutoConfiguration%EF%BC%89/%E8%87%AA%E5%8A%A8%E5%AF%BC%E5%85%A5%E5%8C%85%EF%BC%88@AutoConfigurationPackage%EF%BC%89/%E6%9D%A1%E4%BB%B6%E5%AF%BC%E5%85%A5%EF%BC%88@Conditional%EF%BC%89/" title="Spring/Spring Boot/应用上下文配置类（ConfigurableApplicationContext）/核心注解（@SpringBootApplication）/自动配置类加载（@EnableAutoConfiguration）/自动导入包（@AutoConfigurationPackage）/条件导入（@Conditional）">
									
										条件导入（@Conditional）
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
							</ul>
			
								</li>
							</ul>
			
								</li>
							</ul>
			
								</li>
							</ul>
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2022/09/29/Spring/Spring Boot/全局配置（application.properties）/全局配置（application.properties）/" title="Spring/Spring Boot/全局配置（application.properties）/全局配置（application.properties）">
											全局配置（application.properties）
										</a>
									</a>
									
							<ul>
								<li class="file">
									<a href="/2022/09/29/Spring/Spring%20Boot/%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE%EF%BC%88application.properties%EF%BC%89/%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%88%87%E6%8D%A2/" title="Spring/Spring Boot/全局配置（application.properties）/多环境配置切换">
									
										多环境配置切换
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/09/29/Spring/Spring%20Boot/%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE%EF%BC%88application.properties%EF%BC%89/%E5%B1%9E%E6%80%A7%E5%8A%A0%E5%AF%86/" title="Spring/Spring Boot/全局配置（application.properties）/属性加密">
									
										属性加密
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/09/29/Spring/Spring%20Boot/%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE%EF%BC%88application.properties%EF%BC%89/%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE/" title="Spring/Spring Boot/全局配置（application.properties）/日志配置">
									
										日志配置
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/09/29/Spring/Spring%20Boot/%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE%EF%BC%88application.properties%EF%BC%89/%E5%B1%9E%E6%80%A7%E6%9D%BE%E6%95%A3%E7%BB%91%E5%AE%9A%E8%A7%84%E5%88%99/" title="Spring/Spring Boot/全局配置（application.properties）/属性松散绑定规则">
									
										属性松散绑定规则
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
							</ul>
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2022/09/29/Spring/Spring Boot/全局配置属性注入/全局配置属性注入/" title="Spring/Spring Boot/全局配置属性注入/全局配置属性注入">
											全局配置属性注入
										</a>
									</a>
									
							<ul>
								<li class="file">
									<a href="/2022/09/29/Spring/Spring%20Boot/%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7%E6%B3%A8%E5%85%A5/%E9%80%90%E4%B8%AA%E6%B3%A8%E5%85%A5%EF%BC%88@Value%EF%BC%89/" title="Spring/Spring Boot/全局配置属性注入/逐个注入（@Value）">
									
										逐个注入（@Value）
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/09/29/Spring/Spring%20Boot/%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7%E6%B3%A8%E5%85%A5/%E6%89%B9%E9%87%8F%E6%B3%A8%E5%85%A5%EF%BC%88@ConfigurationProperties%20@EnableConfigurationProperties%EF%BC%89/" title="Spring/Spring Boot/全局配置属性注入/批量注入（@ConfigurationProperties @EnableConfigurationProperties）">
									
										批量注入（@ConfigurationProperties @EnableConfigurationProperties）
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/09/29/Spring/Spring%20Boot/%E8%AF%B7%E6%B1%82%E6%8B%A6%E6%88%AA%EF%BC%88HandlerInterceptor%20&%20Filter%20&%20@WebFilter%EF%BC%89/" title="Spring/Spring Boot/请求拦截（HandlerInterceptor & Filter & @WebFilter）">
									
										请求拦截（HandlerInterceptor & Filter & @WebFilter）
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2022/09/29/Spring/Spring Boot/前后端数据交互对接/前后端数据交互对接/" title="Spring/Spring Boot/前后端数据交互对接/前后端数据交互对接">
											前后端数据交互对接
										</a>
									</a>
									

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2022/09/29/Spring/Spring Boot/前后端数据交互对接/全局响应体处理器（ResponseBodyAdvice）/全局响应体处理器（ResponseBodyAdvice）/" title="Spring/Spring Boot/前后端数据交互对接/全局响应体处理器（ResponseBodyAdvice）/全局响应体处理器（ResponseBodyAdvice）">
											全局响应体处理器（ResponseBodyAdvice）
										</a>
									</a>
									
							<ul>
								<li class="file">
									<a href="/2022/09/29/Spring/Spring%20Boot/%E5%89%8D%E5%90%8E%E7%AB%AF%E6%95%B0%E6%8D%AE%E4%BA%A4%E4%BA%92%E5%AF%B9%E6%8E%A5/%E5%85%A8%E5%B1%80%E5%93%8D%E5%BA%94%E4%BD%93%E5%A4%84%E7%90%86%E5%99%A8%EF%BC%88ResponseBodyAdvice%EF%BC%89/%E5%8F%96%E6%B6%88%E5%B0%81%E8%A3%85/" title="Spring/Spring Boot/前后端数据交互对接/全局响应体处理器（ResponseBodyAdvice）/取消封装">
									
										取消封装
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/09/29/Spring/Spring%20Boot/%E5%89%8D%E5%90%8E%E7%AB%AF%E6%95%B0%E6%8D%AE%E4%BA%A4%E4%BA%92%E5%AF%B9%E6%8E%A5/%E5%85%A8%E5%B1%80%E5%93%8D%E5%BA%94%E4%BD%93%E5%A4%84%E7%90%86%E5%99%A8%EF%BC%88ResponseBodyAdvice%EF%BC%89/%E5%93%8D%E5%BA%94%E4%BD%93%E7%A9%BA%E5%80%BC%E5%A4%84%E7%90%86/" title="Spring/Spring Boot/前后端数据交互对接/全局响应体处理器（ResponseBodyAdvice）/响应体空值处理">
									
										响应体空值处理
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/09/29/Spring/Spring%20Boot/%E5%89%8D%E5%90%8E%E7%AB%AF%E6%95%B0%E6%8D%AE%E4%BA%A4%E4%BA%92%E5%AF%B9%E6%8E%A5/%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%B1%BB/" title="Spring/Spring Boot/前后端数据交互对接/全局异常处理类">
									
										全局异常处理类
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
							</ul>
			
								</li>
							</ul>
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2022/11/29/Spring/事务/事务/" title="Spring/事务/事务">
											事务
										</a>
									</a>
									

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2022/06/29/Spring/事务/TransactionManager 事务管理器/TransactionManager 事务管理器/" title="Spring/事务/TransactionManager 事务管理器/TransactionManager 事务管理器">
											TransactionManager 事务管理器
										</a>
									</a>
									
							<ul>
								<li class="file">
									<a href="/2022/11/29/Spring/%E4%BA%8B%E5%8A%A1/TransactionManager%20%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E5%99%A8/%E4%BA%8B%E5%8A%A1%E5%B1%9E%E6%80%A7/" title="Spring/事务/TransactionManager 事务管理器/事务属性">
									
										事务属性
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/11/29/Spring/%E4%BA%8B%E5%8A%A1/TransactionManager%20%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E5%99%A8/%E4%BA%8B%E5%8A%A1%E7%8A%B6%E6%80%81/" title="Spring/事务/TransactionManager 事务管理器/事务状态">
									
										事务状态
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
							</ul>
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2022/11/29/Spring/事务/声明式事务（xml & 注解）/声明式事务（xml & 注解）/" title="Spring/事务/声明式事务（xml & 注解）/声明式事务（xml & 注解）">
											声明式事务（xml & 注解）
										</a>
									</a>
									

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2022/11/29/Spring/事务/声明式事务（xml & 注解）/配置xml方式/配置xml方式/" title="Spring/事务/声明式事务（xml & 注解）/配置xml方式/配置xml方式">
											配置xml方式
										</a>
									</a>
									
							<ul>
								<li class="file">
									<a href="/2022/11/29/Spring/%E4%BA%8B%E5%8A%A1/%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1%EF%BC%88xml%20&%20%E6%B3%A8%E8%A7%A3%EF%BC%89/%E9%85%8D%E7%BD%AExml%E6%96%B9%E5%BC%8F/%E5%88%9B%E5%BB%BA%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E5%99%A8/" title="Spring/事务/声明式事务（xml & 注解）/配置xml方式/创建事务管理器">
									
										创建事务管理器
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
							</ul>
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2022/11/29/Spring/事务/声明式事务（xml & 注解）/使用注解方式（@Transactional）/使用注解方式（@Transactional）/" title="Spring/事务/声明式事务（xml & 注解）/使用注解方式（@Transactional）/使用注解方式（@Transactional）">
											使用注解方式（@Transactional）
										</a>
									</a>
									
							<ul>
								<li class="file">
									<a href="/2022/11/29/Spring/%E4%BA%8B%E5%8A%A1/%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1%EF%BC%88xml%20&%20%E6%B3%A8%E8%A7%A3%EF%BC%89/%E4%BD%BF%E7%94%A8%E6%B3%A8%E8%A7%A3%E6%96%B9%E5%BC%8F%EF%BC%88@Transactional%EF%BC%89/%E7%8E%AF%E7%BB%95%E9%80%9A%E7%9F%A5%E4%BD%BF%E7%94%A8%E4%BA%8B%E5%8A%A1%EF%BC%88@Around%EF%BC%89/" title="Spring/事务/声明式事务（xml & 注解）/使用注解方式（@Transactional）/环绕通知使用事务（@Around）">
									
										环绕通知使用事务（@Around）
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
							</ul>
			
								</li>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/11/29/Spring/%E4%BA%8B%E5%8A%A1/%E7%BC%96%E7%A8%8B%E5%BC%8F%E4%BA%8B%E5%8A%A1%EF%BC%88TransactionTemplate%20%20&%20PlatformTransactionManager%EF%BC%89/" title="Spring/事务/编程式事务（TransactionTemplate  & PlatformTransactionManager）">
									
										编程式事务（TransactionTemplate  & PlatformTransactionManager）
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
							</ul>
			
								</li>
							</ul>
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2024/06/07/面试题/面试题/" title="面试题/面试题">
											面试题
										</a>
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/06/01/%E9%9D%A2%E8%AF%95%E9%A2%98/1.Java%E5%9F%BA%E7%A1%80%E9%9D%A2%E8%AF%95%E9%A2%98/" title="面试题/1.Java基础面试题">
									
										1.Java基础面试题
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/06/02/%E9%9D%A2%E8%AF%95%E9%A2%98/2.Spring%20%E9%9D%A2%E8%AF%95%E9%A2%98/" title="面试题/2.Spring 面试题">
									
										2.Spring 面试题
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/06/03/%E9%9D%A2%E8%AF%95%E9%A2%98/3.%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9D%A2%E8%AF%95%E9%A2%98/" title="面试题/3.数据库面试题">
									
										3.数据库面试题
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/06/04/%E9%9D%A2%E8%AF%95%E9%A2%98/4.%E4%B8%AD%E9%97%B4%E4%BB%B6%E9%9D%A2%E8%AF%95%E9%A2%98/" title="面试题/4.中间件面试题">
									
										4.中间件面试题
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/06/06/%E9%9D%A2%E8%AF%95%E9%A2%98/5.%E8%BF%90%E7%BB%B4%E9%9D%A2%E8%AF%95%E9%A2%98/" title="面试题/5.运维面试题">
									
										5.运维面试题
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/07/06/%E9%9D%A2%E8%AF%95%E9%A2%98/6.%E5%9C%BA%E6%99%AF%E9%A2%98/" title="面试题/6.场景题">
									
										6.场景题
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/08/07/%E9%9D%A2%E8%AF%95%E9%A2%98/7.%E7%AE%97%E6%B3%95%E9%A2%98/" title="面试题/7.算法题">
									
										7.算法题
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
							</ul>
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2024/06/07/缓存/缓存/" title="缓存/缓存">
											缓存
										</a>
									</a>
									
							<ul>
								<li class="file">
									<a href="/2024/03/27/%E7%BC%93%E5%AD%98/redis/" title="缓存/redis">
									
										redis
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
							</ul>
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2024/06/07/大语言模型/大语言模型/" title="大语言模型/大语言模型">
											大语言模型
										</a>
									</a>
									
								</li>
							</ul>
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2024/06/07/开源测评/开源测评/" title="开源测评/开源测评">
											开源测评
										</a>
									</a>
									
							<ul>
								<li class="file">
									<a href="/2024/03/27/%E5%BC%80%E6%BA%90%E6%B5%8B%E8%AF%84/dataease/" title="开源测评/dataease">
									
										dataease
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/06/07/%E5%BC%80%E6%BA%90%E6%B5%8B%E8%AF%84/jumpserver/" title="开源测评/jumpserver">
									
										jumpserver
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
							</ul>
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2024/06/07/读书笔记/读书笔记/" title="读书笔记/读书笔记">
											读书笔记
										</a>
									</a>
									
							<ul>
								<li class="file">
									<a href="/2021/03/27/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E4%BA%BA%E6%80%A7%E7%9A%84%E6%9E%B7%E9%94%81/" title="读书笔记/人性的枷锁">
									
										人性的枷锁
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2021/03/27/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E9%85%92%E5%9B%BD/" title="读书笔记/酒国">
									
										酒国
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
							</ul>
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2024/06/07/软件测评/软件测评/" title="软件测评/软件测评">
											软件测评
										</a>
									</a>
									
								</li>
							</ul>
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2024/06/07/QA/QA/" title="QA/QA">
											QA
										</a>
									</a>
									
							<ul>
								<li class="file">
									<a href="/2022/06/28/QA/%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/" title="QA/安装部署">
									
										安装部署
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
							</ul>
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2024/06/07/系统设计最佳实践/系统设计最佳实践/" title="系统设计最佳实践/系统设计最佳实践">
											系统设计最佳实践
										</a>
									</a>
									

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2024/06/07/系统设计最佳实践/规范/规范/" title="系统设计最佳实践/规范/规范">
											规范
										</a>
									</a>
									
								</li>
							</ul>
			
								</li>
							</ul>
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										<a class="directory " href="/2024/06/07/运维/运维/" title="运维/运维">
											运维
										</a>
									</a>
									
							<ul>
								<li class="file active">
									<a href="/2024/03/27/%E8%BF%90%E7%BB%B4/springboot%E5%BA%94%E7%94%A8%E5%9F%BA%E4%BA%8Eprometheus%E7%9B%91%E6%8E%A7%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%87%E6%A0%87/" title="运维/springboot应用基于prometheus监控自定义指标">
									
										springboot应用基于prometheus监控自定义指标
									
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
							</ul>
			
		</div>
	</div>
</div>

	<!-- 引入正文 -->
	<div id="content">
		<h1 id="article-title">
	springboot应用基于prometheus监控自定义指标
</h1>
<div class="article-meta">
	<span> David </span>
	<span> 2024-03-27 15:30:00 </span>
	<div id="article-categories">
		
		<span>Categories：</span>
		 
		<span>
			<i class="fa fa-folder" aria-hidden="true">
				<a href="/categories/运维/">
					运维
				</a>
			</i>
			
		</span>
		   
		<span>Tags：</span>
		 
		<span>
			<i class="fa fa-tag" aria-hidden="true">
				<a href="/tags/spring/">
					spring
				</a>
			</i>
		</span>
		  
		<span>
			<i class="fa fa-tag" aria-hidden="true">
				<a href="/tags/prometheus/">
					prometheus
				</a>
			</i>
		</span>
		  
	</div>
</div>

<div id="article-content"><p>系统开发中需要统计很多应用指标, 比如: 接口请求QPS, 接口响应时间统计, 接口耗时发布等. SpringBoot自带的spring-actuator中集成了Micrometer进行度量统计, 然后我们再用Promethues收集存储指标后, 在Grafana中以图标展示.</p>
<ol>
<li>Micrometer</li>
<li>1 Micrometer提供的度量类库<br>在Micrometer中, Meter接口是用于收集应用中度量数据的, 它是由MeterRegistry创建和保存的, 可以将MeterRegistry理解为Meter的工厂和缓存中心. 一般而言, 每个JVM应用在使用Micrometer时都需要创建一个MeterRegistry的具体实现.</li>
</ol>
<p>MeterRegistry在Micrometer中是一个抽象类, 主要实现包括:</p>
<p>SimpleMeterRegistry : 每个Meter的最新数据可以收集到SimpleMeterRegistry实例中，但是这些数据不会发布到其他系统，也就是说数据是位于应用的内存中的。适合调试的时候使用<br>CompositeMeterRegistry: 多个MeterRegistry的聚合<br>全局的MeterRegistry: 工厂类io.micrometer.core.instrument.Metrics中持有一个静态final类型的CompositeMeterRegistry实例<br>1.2 Meter<br>Counter<br>Counter是一种比较简单的Meter, 它的值只能单调递增. 可以用来统计比如: 接口调用次数, 订单总量等. 使用实例</p>
<p>MeterRegistry meterRegistry = new SimpleMeterRegistry();<br>Counter counter = meterRegistry.counter(“http.request”, “createOrder”, “/order/create”);<br>counter.increment();<br>System.out.println(counter.measure()); // [Measurement{statistic=’COUNT’, value=1.0}]<br>通过Tag可以区分不同的场景，对于下单，可以使用不同的Tag标记不同的业务来源或者是按日期划分，对于Http请求总量记录，可以使用Tag区分不同的URL。用下单业务举个例子：</p>
<p>//实体<br>@Data<br>public class Order {</p>
<pre><code>private String orderId;
private Integer amount;
private String channel;
private LocalDateTime createTime;
</code></pre>
<p>}</p>
<p>public class CounterMain {</p>
<pre><code>private static final DateTimeFormatter FORMATTER = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd&quot;);

static &#123;
        Metrics.addRegistry(new SimpleMeterRegistry());
    &#125;

    public static void main(String[] args) throws Exception &#123;
        Order order1 = new Order();
        order1.setOrderId(&quot;ORDER_ID_1&quot;);
        order1.setAmount(100);
        order1.setChannel(&quot;CHANNEL_A&quot;);
        order1.setCreateTime(LocalDateTime.now());
        createOrder(order1);
        Order order2 = new Order();
        order2.setOrderId(&quot;ORDER_ID_2&quot;);
        order2.setAmount(200);
        order2.setChannel(&quot;CHANNEL_B&quot;);
        order2.setCreateTime(LocalDateTime.now());
        createOrder(order2);
        // 通过Micrometer的Search接口查找指标数据
        Search.in(Metrics.globalRegistry).meters().forEach(each -&gt; &#123;
            StringBuilder builder = new StringBuilder();
            builder.append(&quot;name:&quot;)
                    .append(each.getId().getName())
                    .append(&quot;,tags:&quot;)
                    .append(each.getId().getTags())
                    .append(&quot;,type:&quot;).append(each.getId().getType())
                    .append(&quot;,value:&quot;).append(each.measure());
            System.out.println(builder.toString());
        &#125;);
&#125;

private static void createOrder(Order order) &#123;
    //忽略订单入库等操作
    Metrics.counter(&quot;order.create&quot;,
            &quot;channel&quot;, order.getChannel(),
            &quot;createTime&quot;, FORMATTER.format(order.getCreateTime())).increment();
&#125;
</code></pre>
<p>}<br>控制台输出</p>
<p>name:order.create,tags:[tag(channel=CHANNEL_A), tag(createTime=2018-11-10)],type:COUNTER,value:[Measurement{statistic=’COUNT’, value=1.0}]<br>name:order.create,tags:[tag(channel=CHANNEL_B), tag(createTime=2018-11-10)],type:COUNTER,value:[Measurement{statistic=’COUNT’, value=1.0}]<br>上面的例子是使用全局静态方法工厂类Metrics去构造Counter实例，实际上，io.micrometer.core.instrument.Counter接口提供了一个内部建造器类Counter.Builder去实例化Counter，Counter.Builder的使用方式如下：</p>
<p>public static void main(String[] args) throws Exception{<br>    Counter counter = Counter.builder(“name”)  //名称<br>        .baseUnit(“unit”) //基础单位<br>        .description(“desc”) //描述<br>        .tag(“tagKey”, “tagValue”)  //标签<br>        .register(new SimpleMeterRegistry());//绑定的MeterRegistry<br>    counter.increment();<br>}<br>FunctionCounter<br>FunctionCounter是Counter的特化类型, 它把计数器值增加的动作抽象成JDK1.8的接口类型ToDoubleFunction. 它的使用场景与Counter一致, 下面介绍下其语法:</p>
<p>public static void main(String[] args) throws Exception {<br>    MeterRegistry registry = new SimpleMeterRegistry();<br>    AtomicInteger n = new AtomicInteger(0);<br>    //这里ToDoubleFunction匿名实现其实可以使用Lambda表达式简化为AtomicInteger::get<br>    FunctionCounter.builder(“functionCounter”, n, new ToDoubleFunction<AtomicInteger>() {<br>        @Override<br>        public double applyAsDouble(AtomicInteger value) {<br>            return value.get();<br>        }<br>    }).baseUnit(“function”)<br>        .description(“functionCounter”)<br>        .tag(“createOrder”, “CHANNEL-A”)<br>        .register(registry);<br>    //下面模拟三次计数<br>    n.incrementAndGet();<br>    n.incrementAndGet();<br>    n.incrementAndGet();<br>}<br>FunctionCounter使用的一个明显的好处是，我们不需要感知FunctionCounter实例的存在，实际上我们只需要操作作为FunctionCounter实例构建元素之一的AtomicInteger实例即可，这种接口的设计方式在很多框架里面都可以看到。</p>
<p>Timer<br>Timer适用于记录耗时比较短的事件的执行时间, 通过时间发布展示事件的序列和发生频率. 所有的Timer实现至少记录了发生的事件的数量和这些事件的总耗时, 从而生成一个时间序列. Timer的基本单位基于服务端的指标而定, 但是实际上我们不需要过于关注Timer的基本单位，因为Micrometer在存储生成的时间序列的时候会自动选择适当的基本单位。Timer接口提供的常用方法如下：</p>
<p>public interface Timer extends Meter {<br>    …<br>    void record(long var1, TimeUnit var3);</p>
<pre><code>default void record(Duration duration) &#123;
    this.record(duration.toNanos(), TimeUnit.NANOSECONDS);
&#125;

&lt;T&gt; T record(Supplier&lt;T&gt; var1);

&lt;T&gt; T recordCallable(Callable&lt;T&gt; var1) throws Exception;

void record(Runnable var1);

default Runnable wrap(Runnable f) &#123;
    return () -&gt; &#123;
        this.record(f);
    &#125;;
&#125;

default &lt;T&gt; Callable&lt;T&gt; wrap(Callable&lt;T&gt; f) &#123;
    return () -&gt; &#123;
        return this.recordCallable(f);
    &#125;;
&#125;

long count();

double totalTime(TimeUnit var1);

default double mean(TimeUnit unit) &#123;
    return this.count() == 0L ? 0.0D : this.totalTime(unit) / (double)this.count();
&#125;

double max(TimeUnit var1);
...
</code></pre>
<p>}<br>使用下单业务做个例子:</p>
<p>public class TimerMain {</p>
<pre><code>    private static final Random R = new Random();

    static &#123;
        Metrics.addRegistry(new SimpleMeterRegistry());
    &#125;

    public static void main(String[] args) throws Exception &#123;
        Order order1 = new Order();
        order1.setOrderId(&quot;ORDER_ID_1&quot;);
        order1.setAmount(100);
        order1.setChannel(&quot;CHANNEL_A&quot;);
        order1.setCreateTime(LocalDateTime.now());
        Timer timer = Metrics.timer(&quot;timer&quot;, &quot;createOrder&quot;, &quot;cost&quot;);
        timer.record(() -&gt; createOrder(order1));
    &#125;

    private static void createOrder(Order order) &#123;
        try &#123;
            TimeUnit.SECONDS.sleep(R.nextInt(5)); //模拟方法耗时
        &#125; catch (InterruptedException e) &#123;
            //no-op
        &#125;
    &#125;
</code></pre>
<p>}<br>在实际生产环境中，可以通过spring-aop把记录方法耗时的逻辑抽象到一个切面中，这样就能减少不必要的冗余的模板代码。上面的例子是通过Mertics构造Timer实例，实际上也可以使用Builder构造：</p>
<p>MeterRegistry registry = …<br>Timer timer = Timer<br>    .builder(“my.timer”)<br>    .description(“a description of what this timer does”) // 可选<br>    .tags(“region”, “test”) // 可选<br>    .register(registry);<br>另外，Timer的使用还可以基于它的内部类Timer.Sample，通过start和stop两个方法记录两者之间的逻辑的执行耗时。例如：</p>
<p>Timer.Sample sample = Timer.start(registry);</p>
<p>// 这里做业务逻辑<br>Response response = …</p>
<p>sample.stop(registry.timer(“my.timer”, “response”, response.status()));<br>FunctionTimer<br>FunctionTimer是Timer的特化类型, 它需要两个函数:一个用于计数, 一个用于统计总耗时. 它的构造器方法入参如下:</p>
<p>public interface FunctionTimer extends Meter {<br>    static <T> Builder<T> builder(String name, T obj, ToLongFunction<T> countFunction,<br>                                  ToDoubleFunction<T> totalTimeFunction,<br>                                  TimeUnit totalTimeFunctionUnit) {<br>        return new Builder&lt;&gt;(name, obj, countFunction, totalTimeFunction, totalTimeFunctionUnit);<br>    }<br>    …<br>}<br>简单的使用方式如下:</p>
<p>public static void main(String[] args) throws Exception {<br>    //这个是为了满足参数,暂时不需要理会<br>    Object holder = new Object();<br>    AtomicLong totalTimeNanos = new AtomicLong(0);<br>    AtomicLong totalCount = new AtomicLong(0);<br>    // 注意总时间的单位<br>    FunctionTimer.builder(“functionTimer”, holder, p -&gt; totalCount.get(),<br>                          p -&gt; totalTimeNanos.get(), TimeUnit.NANOSECONDS)<br>        .register(new SimpleMeterRegistry());<br>    totalTimeNanos.addAndGet(10000000);<br>    totalCount.incrementAndGet();<br>}<br>LongTaskTimer<br>LongTaskTimer也是Timer的一种特化类型, 主要用于记录长时间执行的任务的持续时间. 在Spring中可以简单地使用@Scheduled和@Timed注解，基于spring-aop完成定时调度任务的总耗时记录：</p>
<p>@Timed(value = “aws.scrape”, longTask = true)<br>@Scheduled(fixedDelay = 360000)<br>void scrapeResources() {<br>    //这里做相对耗时的业务逻辑<br>}<br>也可以手动使用LongTaskTimer</p>
<p>public static void main(String[] args) throws Exception{<br>    MeterRegistry meterRegistry = new SimpleMeterRegistry();<br>    LongTaskTimer longTaskTimer = meterRegistry.more().longTaskTimer(“longTaskTimer”);<br>    longTaskTimer.record(() -&gt; {<br>        //这里编写Task的逻辑<br>    });</p>
<pre><code>//或者这样
Metrics.more().longTaskTimer(&quot;longTaskTimer&quot;).record(()-&gt; &#123;
    //这里编写Task的逻辑
&#125;);
</code></pre>
<p>}<br>Gauge<br>Gauge是用来记录可以上下浮动的单数值度量Meter, 测量值用ToDoubleFunction参数的返回值, 如当前的内存使用情况, 队列中的消息数量等. Gauge一般用于监测有自然上界的事件或者任务，而Counter一般使用于无自然上界的事件或者任务的监测，所以像Http请求总量计数应该使用Counter而非Gauge。 MeterRegistry中提供了一些便于构建用于观察数值、函数、集合和映射的Gauge相关的方法：</p>
<p>List<String> list = registry.gauge(“listGauge”, Collections.emptyList(), new ArrayList&lt;&gt;(), List::size);<br>List<String> list2 = registry.gaugeCollectionSize(“listSize2”, Tags.empty(), new ArrayList&lt;&gt;());<br>Map&lt;String, Integer&gt; map = registry.gaugeMapSize(“mapGauge”, Tags.empty(), new HashMap&lt;&gt;());<br>上面的三个方法通过MeterRegistry构建Gauge并且返回了集合或者映射实例，使用这些集合或者映射实例就能在其size变化过程中记录这个变更值。更重要的优点是，我们不需要感知Gauge接口的存在，只需要像平时一样使用集合或者映射实例就可以了。此外，Gauge还支持java.lang.Number的子类，java.util.concurrent.atomic包中的AtomicInteger和AtomicLong，还有Guava提供的AtomicDouble:</p>
<p>AtomicInteger n = registry.gauge(“numberGauge”, new AtomicInteger(0));<br>n.set(1);<br>n.set(2);<br>除了使用MeterRegistry创建Gauge之外，还可以使用建造器流式创建：</p>
<p>//一般我们不需要操作Gauge实例<br>Gauge gauge = Gauge<br>    .builder(“gauge”, myObj, myObj::gaugeValue)<br>    .description(“a description of what this gauge does”) // 可选<br>    .tags(“region”, “test”) // 可选<br>    .register(registry);<br>举个相对实际的例子，假设我们需要对登录后的用户发送一条短信或者推送，做法是消息先投放到一个阻塞队列，再由一个线程消费消息进行其他操作：</p>
<p>private static final MeterRegistry REGISTRY = new SimpleMeterRegistry();<br>private static final BlockingQueue<Message> QUEUE = new ArrayBlockingQueue&lt;&gt;(500);<br>private static BlockingQueue<Message> REAL_QUEUE;</p>
<p>static {<br>    REAL_QUEUE = REGISTRY.gauge(“messageGauge”, QUEUE, Collection::size);<br>}</p>
<p>public static void main(String[] args) throws Exception {<br>    consume();<br>    Message message = new Message();<br>    message.setUserId(1L);<br>    message.setContent(“content”);<br>    REAL_QUEUE.put(message);<br>}</p>
<p>private static void consume() throws Exception {<br>    new Thread(() -&gt; {<br>        while (true) {<br>            try {<br>                Message message = REAL_QUEUE.take();<br>                //handle message<br>                System.out.println(message);<br>            } catch (InterruptedException e) {<br>                //no-op<br>            }<br>        }<br>    }).start();<br>}<br>TimeGauge<br>TimeGauge是Gauge的特化类型, 相比Gauge, 它的构造器中多了一个TimeUnit类型的参数, 用于指定ToDoubleFunction入参的时间单位.</p>
<p>private static final SimpleMeterRegistry REGISTRY = new SimpleMeterRegistry();</p>
<p>public static void main(String[] args) throws Exception{<br>    AtomicInteger count = new AtomicInteger();<br>    TimeGauge.Builder<AtomicInteger> timeGauge = TimeGauge.builder(“timeGauge”, count,<br>                                                                   TimeUnit.SECONDS, AtomicInteger::get);<br>    timeGauge.register(R);<br>    count.addAndGet(10086);<br>    print();<br>    count.set(1);<br>    print();<br>}</p>
<p>private static void print()throws Exception{<br>    Search.in(REGISTRY).meters().forEach(each -&gt; {<br>        StringBuilder builder = new StringBuilder();<br>        builder.append(“name:”)<br>            .append(each.getId().getName())<br>            .append(“,tags:”)<br>            .append(each.getId().getTags())<br>            .append(“,type:”).append(each.getId().getType())<br>            .append(“,value:”).append(each.measure());<br>        System.out.println(builder.toString());<br>    });<br>}<br>控制台输出</p>
<p>name:timeGauge,tags:[],type:GAUGE,value:[Measurement{statistic=’VALUE’, value=10086.0}]<br>name:timeGauge,tags:[],type:GAUGE,value:[Measurement{statistic=’VALUE’, value=1.0}]<br>DistributionSummary<br>Summary主要用于跟踪事件的发布, 使用方式与Timer类型, 但是它的记录值并不依赖与时间单位. 常见的场景: 记录请求的有效负载大小. 使用MeterRegistry创建DistributionSummary的方式如下:</p>
<p>DistributionSummary summary = registry.summary(“response.size”);<br>使用构造器流式创建:</p>
<p>DistributionSummary summary = DistributionSummary<br>    .builder(“response.size”)<br>    .description(“a description of what this summary does”) // 可选<br>    .baseUnit(“bytes”) // 可选<br>    .tags(“region”, “test”) // 可选<br>    .scale(100) // 可选<br>    .register(registry);<br>使用例子:</p>
<p>private static final DistributionSummary SUMMARY  = DistributionSummary.builder(“cacheHitPercent”)<br>    .register(new SimpleMeterRegistry());</p>
<p>private static final LoadingCache&lt;String, String&gt; CACHE = CacheBuilder.newBuilder()<br>    .maximumSize(1000)<br>    .recordStats()<br>    .expireAfterWrite(60, TimeUnit.SECONDS)<br>    .build(new CacheLoader&lt;String, String&gt;() {<br>        @Override<br>        public String load(String s) throws Exception {<br>            return selectFromDatabase();<br>        }<br>    });</p>
<p>public static void main(String[] args) throws Exception{<br>    String key = “dog”;<br>    String value = CACHE.get(key);<br>    record();<br>}</p>
<p>private static void record()throws Exception{<br>    CacheStats stats = CACHE.stats();<br>    BigDecimal hitCount = new BigDecimal(stats.hitCount());<br>    BigDecimal requestCount = new BigDecimal(stats.requestCount());<br>    SUMMARY.record(hitCount.divide(requestCount, 2, BigDecimal.ROUND_HALF_DOWN).doubleValue());<br>}<br>2. SpringBoot应用开发<br>2.1 Maven依赖配置<br>在pom.xml中增加如下依赖</p>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>

<dependency>
    <groupId>io.micrometer</groupId>
    <artifactId>micrometer-registry-prometheus</artifactId>
</dependency>
然后spring的配置类中, 为所有指标配置默认标签(应用名, 本机IP)

<p>@Bean<br>MeterRegistryCustomizer<MeterRegistry> configurer(@Value(“${spring.application.name}”) String applicationName) {<br>    // 添加全局标签, micrometer 1.1.0 之后可以通过配置文件方式添加<br>    return registry -&gt; registry.config().commonTags(“application”, applicationName).commonTags(“ip”, cn.hutool.core.net.NetUtil.getLocalhostStr());<br>}<br>在spring配置文件中将actuator相关端点暴露出去</p>
<p>management:<br>  metrics:<br>    tags:<br>      # micrometer 1.1.0之后使用该方式配置全局标签<br>      application: ${spring.application.name}<br>  endpoints:<br>    web:<br>      exposure:<br>        include: “*”<br>2.2 自定义指标开发<br>下面在一个接口内演示所有指标的用法</p>
<p>@RestController<br>@RequestMapping(“/user”)<br>public class UserController {<br>    @Autowired<br>    MeterRegistry registry;</p>
<pre><code>private Counter counter;
private AtomicInteger gauge;
private DistributionSummary summary;
private LongTaskTimer long_task_timer;
private DistributionSummary summarySimple;

@PostConstruct
private void init() &#123;
    // Gauge.builder(&quot;lego.thread-pool.pending_task&quot;, new AtomicInteger(37), AtomicInteger::get);
    Tags tags = Tags.of(&quot;endpoint&quot;, &quot;user&quot;);
    counter = Counter.builder(&quot;counter_user&quot;).tag(&quot;method&quot;, &quot;IndexController.core&quot;).register(registry);
    gauge = registry.gauge(&quot;guage_user&quot;, new AtomicInteger(0));
    summarySimple = registry.summary(&quot;summary_user&quot;);
    
    // 客户端计算百分位publishPercentiles 发布直方图publishPercentileHistogram(指标较多, 谨慎开启)
    summary = DistributionSummary.builder(&quot;summary_quantile&quot;).scale(100).publishPercentiles(0.5, 0.8, 0.95)
                                 .publishPercentileHistogram().register(registry);
    long_task_timer = registry.more().longTaskTimer(&quot;long_task_timer_user&quot;);
&#125;

@GetMapping
public void testMetrics() throws InterruptedException &#123;
    counter.increment();
    gauge.getAndSet(RandomUtils.nextInt(0, 100000));

    Timer.Sample sample = Timer.start(registry);
    // 模拟业务操作
    Thread.sleep(RandomUtils.nextInt(10, 1000));
    sample.stop(Timer.builder(&quot;timer_user&quot;).description(&quot;一段描述&quot;)
                     .tags(&quot;endpoint&quot;, &quot;user&quot;).publishPercentileHistogram(true)
                     .publishPercentiles(0.5, 0.75, 0.9)
                     .register(registry));


    summarySimple.record(RandomUtils.nextDouble(10, 1000));
    summary.record(RandomUtils.nextDouble(10, 1000));
    long_task_timer.start();
    long_task_timer.record(() -&gt; RandomUtils.nextInt(10, 10000));
&#125;
</code></pre>
<p>}<br>应用启动后, 请求<a href="http://localhost:端口/user接口">http://localhost:端口/user接口</a>, 模拟业务接口访问, 然后在打开<a href="http://localhost:端口/actuator/prometheus就可以看到所有指标了">http://localhost:端口/actuator/prometheus就可以看到所有指标了</a>. 除了我们自定义的指标, 还是许多默认的JVM, http请求的指标, 这些指标在Grafana中使用已经配置好的图标模板JVM (Micrometer) 或者 Spring Boot Statistics就可以展示了.</p>
<p>3.Promethues/Grafana配置<br>3.1 Prometheus配置<br>应用端配置好以后, 还需要配置Promethues去定时从应用拉取数据并保存起来. Promethues安装好以后, 编辑其配置文件(prometheus.yml)</p>
<p>scrape_configs:<br>    # 新增如下行</p>
<ul>
<li>job_name: ‘springboot-micrometer’<h1 id="请求间隔"><a href="#请求间隔" class="headerlink" title="请求间隔"></a>请求间隔</h1>scrape_interval: 5s<h1 id="请求路径"><a href="#请求路径" class="headerlink" title="请求路径"></a>请求路径</h1>metrics_path: ‘/actuator/prometheus’<h1 id="应用服务地址"><a href="#应用服务地址" class="headerlink" title="应用服务地址"></a>应用服务地址</h1>static_configs:<ul>
<li>targets: [‘172.31.47.13:8880’]<br>然后重启Promethues. 然后打开Promethues的管理页面<a target="_blank" rel="noopener" href="http://ip:9090/targets">http://IP:9090/targets</a>, 选择Status &gt; Targets, 查看应用端点状态是否为UP. 点击Graph可以通过PromQL查询指标数据, 如: long_task_timer_user_seconds_duration_sum</li>
</ul>
</li>
</ul>
<p>3.2 Grafana图标配置<br>Promethues中有数据以后, 还需要在Grafana中以图表展示, 方便查看. 首先在Grafana配置好Promethues数据源, 然后可以新建一个Dashboard, 在其中配置不同指标的Panel. 配置语法如下:</p>
<p>Counter</p>
<p>counter_user_total{instance=”$instance”, application=”$application”}<br>rate(counter_user_total{instance=”$instance”, application=”$application”}[1m])<br>Timer</p>
<p>timer_user_seconds_count{instance=”$instance”, application=”$application”}<br>rate(timer_user_seconds_sum{instance=”$instance”, application=”$application”}[1m])/rate(timer_user_seconds_count{instance=”$instance”, application=”$application”}[1m])<br>Gauge</p>
<p>guage_user{application=”$application”, instance=”$instance”}<br>Summary</p>
<p>irate(http_server_requests_seconds_count{instance=”$instance”, application=”$application”, uri!~”.actuator.“}[3m])</p>
<p>可以在Legend填写标签, 这样可以根据标签值自动新建折线 [] -</p>
<p>3.3 Promethues 查询语法PromQL<br>3.3.1 操作符<br>数学运算</p>
<p>PromQL支持的数学运算符: +(加) -(减) *(乘) /(除) %(取余) ^(幂运算)</p>
<p>node_memory_free_bytes_total / (1024 * 1024)<br>布尔运算</p>
<p>支持的布尔运算符: ==(相等) !=(不等) &gt;(大于) &lt;(小于) &gt;=(大于等于) &lt;=(小于等于)</p>
<p>(node_memory_bytes_total - node_memory_free_bytes_total) / node_memory_bytes_total &gt; 0.95<br>bool运算符</p>
<p>通过bool运算符对布尔运算结果进行修改</p>
<h1 id="如果大于1000返回1-true-否则返回0-false"><a href="#如果大于1000返回1-true-否则返回0-false" class="headerlink" title="如果大于1000返回1(true) 否则返回0(false)"></a>如果大于1000返回1(true) 否则返回0(false)</h1><p>http_requests_total &gt; bool 1000<br>集合运算符</p>
<p>支持的集合运算符: and(且) or(或) unless(排除)</p>
<p>vector1 and vector2 会产生一个由vector1的元素组成的新的向量。该向量包含vector1中完全匹配vector2中的元素组成。</p>
<p>vector1 or vector2 会产生一个新的向量，该向量包含vector1中所有的样本数据，以及vector2中没有与vector1匹配到的样本数据。</p>
<p>vector1 unless vector2 会产生一个新的向量，新向量中的元素由vector1中没有与vector2匹配的元素组成。</p>
<p>操作符优先级</p>
<p>100 * (1 - avg (irate(node_cpu{mode=’idle’}[5m])) by(job) )<br>^<br>*, /, %<br>+, -<br>==, !=, &lt;=, &lt;, &gt;=, &gt;<br>and, unless<br>or<br>3.3.2 集合函数<br>sum(求和)</p>
<h1 id="假设系统的日志counter指标如下"><a href="#假设系统的日志counter指标如下" class="headerlink" title="假设系统的日志counter指标如下"></a>假设系统的日志counter指标如下</h1><p>logback_events_total{application=”untitled”,ip=”172.17.0.1”,level=”info”,} 12.0<br>logback_events_total{application=”untitled”,ip=”172.17.0.1”,level=”debug”,} 707.0<br>logback_events_total{application=”untitled”,ip=”172.17.0.1”,level=”trace”,} 0.0<br>logback_events_total{application=”untitled”,ip=”172.17.0.1”,level=”warn”,} 106.0<br>logback_events_total{application=”untitled”,ip=”172.17.0.1”,level=”error”,} 101.0</p>
<h1 id="计算各个level日志的总量"><a href="#计算各个level日志的总量" class="headerlink" title="计算各个level日志的总量"></a>计算各个level日志的总量</h1><p>sum(logback_events_total)<br>min(最小值)</p>
<p>max(最大值)</p>
<p>avg(平均值)</p>
<p>stddev(标准差)</p>
<p>stdvar(标准方差)</p>
<p>count(计数)</p>
<p>count_values(相同数值分组计数)</p>
<p>bottomk (最小的n条数据)</p>
<p>topk (最大的n条数据)<br>3.3.3 内置函数<br>increase</p>
<p>取时间范围内的最后一个值减去第一个值, 得到增长量</p>
<h1 id="计算5分钟内的增长量"><a href="#计算5分钟内的增长量" class="headerlink" title="计算5分钟内的增长量"></a>计算5分钟内的增长量</h1><p>increase(http_requests_total{job=”api-server”}[5m])</p>
<h1 id="计算5分钟内的每秒增长率"><a href="#计算5分钟内的每秒增长率" class="headerlink" title="计算5分钟内的每秒增长率"></a>计算5分钟内的每秒增长率</h1><p>increase(http_requests_total{job=”api-server”}[5m])/300<br>rate</p>
<p>计算每秒的增长率</p>
<h1 id="计算5分钟内的每秒增长率-1"><a href="#计算5分钟内的每秒增长率-1" class="headerlink" title="计算5分钟内的每秒增长率"></a>计算5分钟内的每秒增长率</h1><p>rate(http_requests_total{job=”api-server”}[5m])</p>
<h1 id="等同于"><a href="#等同于" class="headerlink" title="等同于"></a>等同于</h1><p>increase(http_requests_total{job=”api-server”}[5m])/300<br>irate</p>
<p>使用increase或者1函数计算平均增长率时, 会有”长尾问题”, 无法反应时间窗口内的数据突变. 比如某一时刻数据突增, 但是平摊到时间窗口后增长率并不突出. 为了解决该问题, 可以使用irate函数, 它通过时间窗口内的最后两个数据的差值来计算正常率, 所以irate反应的是数据的瞬时增长率.</p>
<p>由于irate灵敏度更高, 所以在需要分享长期趋势或在告警规则中, 这种灵敏度反而会造成干扰, 因此此时更推荐使用rate函数.</p>
<h1 id="5m内的数据增长率"><a href="#5m内的数据增长率" class="headerlink" title="5m内的数据增长率"></a>5m内的数据增长率</h1><p>irate(http_requests_total{job=”api-server”}[5m])<br>predict_linear 预测</p>
<p>基于简单线性回归, 对时间范围内的数据进行统计, 预测某段时间后的数值. 只适用于Gauge类型数据</p>
<h1 id="基于5分钟的数据-预测对300秒后数值"><a href="#基于5分钟的数据-预测对300秒后数值" class="headerlink" title="基于5分钟的数据, 预测对300秒后数值"></a>基于5分钟的数据, 预测对300秒后数值</h1><p>predict_linear(guage_user[5m], 300)<br>histogram_quantile 分位数</p>
<p>统计不同百分比</p>
<h1 id="TYPE-timer-user-seconds-histogram"><a href="#TYPE-timer-user-seconds-histogram" class="headerlink" title="TYPE timer_user_seconds histogram"></a>TYPE timer_user_seconds histogram</h1><p>timer_user_seconds{application=”untitled”,endpoint=”user”,ip=”172.17.0.1”,quantile=”0.5”,} 0.484442112<br>timer_user_seconds{application=”untitled”,endpoint=”user”,ip=”172.17.0.1”,quantile=”0.75”,} 0.70254592<br>timer_user_seconds{application=”untitled”,endpoint=”user”,ip=”172.17.0.1”,quantile=”0.9”,} 0.903872512<br>timer_user_seconds_bucket{application=”untitled”,endpoint=”user”,ip=”172.17.0.1”,le=”0.001”,} 0.0<br>timer_user_seconds_bucket{application=”untitled”,endpoint=”user”,ip=”172.17.0.1”,le=”0.001048576”,} 0.0<br>timer_user_seconds_bucket{application=”untitled”,endpoint=”user”,ip=”172.17.0.1”,le=”0.001398101”,} 0.0<br>timer_user_seconds_bucket{application=”untitled”,endpoint=”user”,ip=”172.17.0.1”,le=”0.001747626”,} 0.0<br>timer_user_seconds_bucket{application=”untitled”,endpoint=”user”,ip=”172.17.0.1”,le=”0.002097151”,} 0.0<br>timer_user_seconds_bucket{application=”untitled”,endpoint=”user”,ip=”172.17.0.1”,le=”0.002446676”,} 0.0<br>…</p>
<h1 id="在过去1小时内的P95（95-的请求耗时都小于等于这个值）"><a href="#在过去1小时内的P95（95-的请求耗时都小于等于这个值）" class="headerlink" title="在过去1小时内的P95（95%的请求耗时都小于等于这个值）"></a>在过去1小时内的P95（95%的请求耗时都小于等于这个值）</h1><p>histogram_quantile(0.95, rate(timer_user_seconds_bucket[1h]))</p>
</div>

<!-- post-guide -->



<div class="post-guide">
<div class="item left">

<a href="/2024/03/27/%E7%BC%93%E5%AD%98/redis/">
<i class="fa fa-angle-left" aria-hidden="true"></i>
Redis
</a>

</div>
<div class="item right">

<a href="/2024/06/07/%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/">
大语言模型
<i class="fa fa-angle-right" aria-hidden="true"></i>
</a>

</div>
</div>


<!-- giscus -->



<script>
	
</script>
	</div>
	<div id="footer">
	<p>
		
			©2022<span>-</span><span>2024
		
		
		</span>
		<a target="_blank" rel="noopener" href="https://github.com/wangchangwei">
			David
		</a>

		 |
		<span id="busuanzi_container_site_pv">
			pv
			<span id="busuanzi_value_site_pv"></span>
		</span>
		|
		<span id="busuanzi_container_site_uv">
			uv
			<span id="busuanzi_value_site_uv"></span>
		</span>
		
		<br />
		Theme
		<a
			href="https://github.com/Exisi/hexo-theme-node-tree"
			target="_blank"
			>Node-Tree</a
		>
		Powered by
		<a href="https://hexo.io" target="_blank">Hexo</a>
	</p>
</div>
	<button id="totop-toggle" class="toggle"><i class="fa fa-angle-double-up" aria-hidden="true"></i></button>
</body>
</html>